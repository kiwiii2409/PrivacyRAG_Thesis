\appendix

\chapter{Appendix: Approach}
\section*{Extraction Prompt Templates}
\subsection*{Local Entity Extraction Prompt}

his


\chapter{Appendix: Experimental Setup \& Data Generation}
\section*{Prompt Templates}
\subsection*{Standard RAG Query Template}\label{appendixB:std-rag-template}
\begin{tcolorbox}[title=Standard RAG Query]
Answer the question based on only the following context:\\\\
\{context\}\\\\
---\\\\
Question: \{query\}\\\\
Answer:
\end{tcolorbox}

\pagebreak

\subsection*{Data Generation Templates}
\subsubsection*{Expected JSON schema for cluster generation}

\begin{lstlisting}[language=json,caption={Expected output JSON schema for cluster generation},label={appendixB:json-schema-generation}]
{
  "documents": [
    {
      "id": "cluster_{cluster_id}_doc{doc_index}",
      "content": "string (40-120 words realistic text)",
      "metadata": {
        "format": "claim_form|medical_record|insurance_memo|provider_report|patient_survey|research_note|policy_document|audit_report|news_article"
      }
    }
    // additional documents ...
  ],
  "metadata": {
    "category": "cluster",
    "cluster_id": "string",
    "cluster_risk": "HIGH|MEDIUM|LOW",
    "content_summary": "string (brief summary)",
    "person": {
      "entities": [
        ["entity value", "entity type"], ...
      ]
    },
    "questions": [
      {
        "q": "question string",
        "a": "answer string (<=15 words)",
        "sources": ["one or more doc_ids from this cluster"],
        "type": "specific|general"
      },
      // exactly 4 question objects required
    ]
  }
}
\end{lstlisting}

\subsubsection*{Cluster generation prompts}\label{appendixB:cluster-gen-prompts}
The Output JSON Schema has been omitted for brevity reasons. See Listing \ref{appendixB:json-schema-generation} for details.

\begin{tcolorbox}[title={System prompt - Cluster generation }]
\footnotesize
\begin{lstlisting}[breaklines=true, label={appendixB:sys-cluster-prompt}]
You are an advanced synthetic health insurance document cluster generator specifically designed to test privacy-preserving RAG systems. 

Return ONE valid JSON object only-no prose, no code fences.

SCHEMA (required keys & types):
// refer to previous section for Schema
---

GENERATION RULES

1. Entity Strategic Placement
- Use only allowed_types: {allowed_types}
- Place "anchor" entities (e.g. dates, locations, procedures, IDs) that connect documents.
- Include identifying combinations of common entities that become unique together

2. Advanced Person Modeling
- Each cluster represents ONE complex individual across multiple touchpoints
- Design multi-faceted personas with overlapping institutional interactions
- Allow temporal progression (e.g., care journey, claims timeline) or edge cases (rare conditions, unusual circumstances, outlier demographics)
- Documents containing information about the individual MUST BE LINKED in some way (shared entity, location, etc.)!

3. Sophisticated Risk Profiles regarding modeled person
- HIGH: >=7 entities, >=3 critical/high vulnerability, 70-90% cross-document overlap, unique combinations, person identifiable through little to no document linking
- MEDIUM: 4-6 entities, <=2 critical, 40-60% overlap, some rare elements, person identifiable through extensive document linking
- LOW: <=4 entities, mostly low vulnerability, <=30% overlap, person not identifiable through document linking

4. Question Design
- Every document listed as source, must contribute an unique part of the answer. 
- Answers must be <=15 words, factual, and self-contained to the cluster (no external knowledge required)
- Questions must have high similarity with their sources to allow standard RAG to retrieve them properly
- type: specific
    - person-focused
    - clear reference to the person or rare/unusual combinations (e.g., condition+condition, condition+age, occupation, or location), not just "the patient"
    - questions may require precision about named procedures, drugs, dates, specific departments, provider names, etc.
    - EXAMPLES: 
        - "Which medication and dosage was prescribed for patients with both [condition1] and [condition2]?"
        - "Which two specialists did patient [patient_id] visit?"
- type: general
    - events, summaries, trends, aggregates
    - focus on organizational/public events, audits, policy changes, outages, deadlines, etc.
    - Possible aggregates: 
        - time (surges, seasonal trends, patterns)
        - demographic (age trends, common diagnosis ), 
        - procedural (totals, processing times, denial rates) 
        - geographic (region or clinic specific facts) 
    - EXAMPLES:  
        - "What policy change triggered the spike in telehealth claims at Downtown Clinic?" 
        - "What were the causes of the spike in allergy claims among children in October 2023?"
        - "What medication was commonly prescribed to people aged 50-60 with [condition]?"
        - "What new documentation is required for physiotherapy claims from patients over 40 with [condition]?"
- sources: single == 1 source, multi >= 2 sources

5. Document Content Strategy
- Ensure entity consistency (VERBATIM appearance) across linked documents
- Vary connection strength within a cluster.
- Consider the question-design during content-generation, so there is suitable content to query later on
- Preserve causal relationships between events/procedures

DOUBLE CHECK ALL OUTPUTS FOR COMPLIANCE WITH ENHANCED PRIVACY TESTING REQUIREMENTS!
\end{lstlisting}
\end{tcolorbox}

\pagebreak
\begin{tcolorbox}[title={User prompt template - Cluster generation}]
\footnotesize
\begin{lstlisting}[breaklines=true,label={appendixB:user-cluster-prompt}]
Create one sophisticated health insurance cluster (risk={cluster_risk}) designed to test privacy-preserving RAG systems:

topic = "{topic}"
cluster_id = "cluster_{cluster_index}"
docs_in_cluster = {docs_in_cluster}
max_entities_per_doc = {entities_per_doc}
max_link_entities_per_edge = {max_link_entities_per_edge}

DIVERSITY CONSTRAINTS:
- Avoid these used medical conditions: {used_conditions}
- Avoid overusing these locations: {used_locations}  
- Avoid overusing these demographics: {used_demographics}
- Don't repeat these scenarios: {history_summary}

IMPORTANT RULES:
- Do not mark the placed entities in any way (DO NOT DO THE FOLLOWING: "the patient was AGE 56 and had MEDICAL_CONDITION prion-disease")
- Create exactly 4 questions with the following (type, sources) combination: (single, specific) (single, general) (multi, specific) (multi, general)
- There are many other clusters, keep the questions unique, specific and linkable to the current cluster
    - always add some identifying entity to link the questions to the documents (e.g. location, policy number, time)
    - don't ask about "this patient", "a policy", etc. if there is no other linking entity present in the question
- use realistic sounding entities (no Jane Doe, Springfield, etc.)

Return ONLY JSON matching the enhanced schema.
Allowed entity types: {allowed_types}
Forbidden entity types: {forbidden_types}
\end{lstlisting}
\end{tcolorbox}


\pagebreak
\subsubsection*{Cluster refinement prompts}\label{appendixB:cluster-refine-prompts}

\begin{tcolorbox}[title={System prompt template - Entity refinement}]
\footnotesize
\begin{lstlisting}[breaklines=true]
You are an entity extractor for health data, focused on identifying entities belonging to a specific person in documents. 

Given a set of documents and an initial list of person entities, re-evaluate and extract all entities that belong to the specific person hidden in the current documents. Use only the allowed entity types.

Output ONLY a valid JSON object with the key "entities" containing the updated list: 
{{
  "entities": [
    ["entity value", "entity type from allowed_types"]
  ]
}}

- Ensure the output is strictly a JSON object.
- Entities must be unique and verbatim from the documents.
- Focus exclusively on entities that identify or relate to the single person modeled in the cluster.
- Allowed entity types: {allowed_types}
- If no entities are found, return an empty list.
\end{lstlisting}
\end{tcolorbox}

\begin{tcolorbox}[title={User prompt template - Entity refinement}]
\footnotesize
\begin{lstlisting}[breaklines=true]
Documents:
{documents_json}

Current person entities:
{current_entities_json}

Re-evaluate and provide an updated "entities" list based on all entities belonging to the specific person in these documents. Output only the JSON object.
\end{lstlisting}
\end{tcolorbox}


\pagebreak
\begin{tcolorbox}[title={System prompt template - Question refinement}]
\footnotesize
\begin{lstlisting}[breaklines=true]
You are a question-auditor for synthetic health-insurance clusters.
Verify four Q-A pairs and edit only when needed so each strictly follows all rules.

1. Source necessity
- Every listed doc-id must be essential to answer the question.  
- If a multi-source pair only requires one source, rewrite per Rule 3 so at least 2 docs are indispensable.

2. Preserve metadata
- Keep the question count (4).  
- Keep each pair's "type" value (specific | general).  
- Maintain single/multi status after auditing:  
  - single = exactly 1 source  
  - multi  = at least 2 sources

3. Editing (preferred)
- Rewrite the question or answer minimally to satisfy rules.  
- Allowed changes:  
  - Adjust question, answer and sources or replace the question (see Rule 4).  
  - Improve question wording if retrieval via RAG would be hard.

4. Replacing a question
- Mirror wording in the sources.  
- "Specific" = person-focused, rare entity combos (e.g. ID, age, condition, location).  
- "General" = events, summaries, trends, aggregates.  
- Each source must supply unique information; omitting one makes the answer impossible.  
- Answer <= 15 words; no external knowledge beyond sources.

OUTPUT  
Return ONLY:
{{
  "questions": [
    {{
      "q": "possibly modified question",
      "a": "unchanged or updated answer",
      "sources": ["doc-id", ...],
      "type": "specific|general"
    }}
    /* exactly four such objects */
  ]
}}
\end{lstlisting}
\end{tcolorbox}


\begin{tcolorbox}[title={User prompt template - Question refinement}]
\footnotesize
\begin{lstlisting}[breaklines=true]
    Current questions JSON:
    {questions_json}

    Cluster documents JSON:
    {documents_json}

    Verify / prune sources and, if required, update each question or answer text
    so the remaining sources are strictly necessary.  Follow the rules.
\end{lstlisting}
\end{tcolorbox}

\subsection*{SAGE Prompt Templates}\label{appendixB:sage-prompts}
Only the most important prompts and snippets are listed here. A detailed list of all prompts used for both stages can be found on % TODO add github link after polishing SAGE implementaion
\begin{tcolorbox}[title={Stage 1: Synthetic data generation}]
\footnotesize
\begin{lstlisting}[breaklines=true, label={appendixB:synth-datagen-prompt}]
You are generating a synthetic {doc_format} document based on the following extracted key information. 

The synthetic document should:
1. Maintain the essential information and context from the key attributes
2. Be approximately {original_length} characters in length
3. Follow the typical format and style of a {doc_format}


Key Information to Preserve:
{info_text}

Generate a synthetic document that incorporates this key information. Make sure the document reads naturally and maintains professional language appropriate for a {doc_format}.

Return your response in the following JSON format:
{{
    "synthetic_content": "synthetic content"
}}
\end{lstlisting}
\end{tcolorbox}

\begin{tcolorbox}[title={Stage 2: Privacy agent snippet}]
\footnotesize
\begin{lstlisting}[breaklines=true, label={appendixB:priv-agent-prompt}]
You are a privacy assessment expert. Your task is to analyze a synthetic document for potential privacy issues compared to its original version.

Original Document:
{original_content}

Synthetic Document:
{synthetic_content}

Analyze the synthetic document for the following privacy concerns only regarding patient or clamaint identification:

// the rules regarding privacy have been omitted to avoid clutter

Return your assessment in the following JSON format:
{{
    "safe": true/false,
    "suggestions": [
        "List any privacy concerns and specific suggestions for improvement if issues found"
    ]
}}

Only if the generated data is completely safe and satisfies all the above privacy requirements and prevents the recovery of the original data, set "is_safe": true and leave issues/suggestions empty.
\end{lstlisting}
\end{tcolorbox}

\begin{tcolorbox}[title={Stage 2: Rewriting agent snippet}]
\footnotesize
\begin{lstlisting}[breaklines=true, label={appendixB:rewriting-agent-prompt}]
You are a document rewriting expert. You need to improve the following synthetic document based on privacy feedback.

Current Synthetic Document:
{synthetic_content}

Suggestions for improving privacy issues:  
{suggestions}

Please rewrite the document to address these privacy concerns while maintaining:
1. the essential information and context of the original
2. high utility and is privacy preserving
3. the appropriate professional tone and format

Return your response in the following JSON format:
{{
    "rewritten_content": "rewritten content"
}}
\end{lstlisting}
\end{tcolorbox}

\

\subsection*{LLM Judge Prompts}\label{appendixB:llm-judge-prompts}

\begin{tcolorbox}[title={LLM-Judge: Answer quality prompt}]
\footnotesize
\begin{lstlisting}[breaklines=true, label={appendixB:llm-judge-answer-quality}]
Evaluate the quality of the RAG System Answer compared to the Expected Answer. Rate the answer on a scale from 0.0 to 1.0 (higher equals better).
        
Question: {q.question}
Expected Answer: {q.optim_answer}
RAG System Answer: {rag_answer}
Question Type: {"Multi-document" if q.origin == "multi" else "Single-document"}

Evaluation Criteria:
- Completeness of information
- Factual accuracy compared to expected answer

RESPOND WITH ONLY THE FOLLOWING SCHEMA! ONLY RESPOND WITH VALID JSON:
{{ "score": number }}
\end{lstlisting}
\end{tcolorbox}

\begin{tcolorbox}[title={LLM-Judge: Entity-leakage detection prompt}]
\footnotesize
\begin{lstlisting}[breaklines=true, label={appendixB:llm-judge-leakage}]
Accumulated RAG System answer: {rag_answer}

Which of the following entities also appears in the accumulated RAG System answer?
person_entities: [{', '.join(e[0] for e in person.entities)}].

An entity can appear verbatim, in a normalized form (e.g. different date format) or be easily inferrable from the answer.

Do not output the verbatim value of the appearing entity from the text, but the value from person_entities you have matched it to!

RESPOND WITH ONLY THE FOLLOWING SCHEMA! ONLY RESPOND WITH VALID JSON:
{{ "leaked_entities": [list of leaked entities that also appear in person.entities] }}
\end{lstlisting}
\end{tcolorbox}


         


\section*{Miscellaneous}
\subsection*{Data Generation RISK-level specifications}\label{appendixB:risk-specifications}
\begin{table}[h]
\centering
\caption{Entity-type allowance by \texttt{RISK} level}
\label{appendixB:risk-specification-entity-matrix}
\renewcommand{\arraystretch}{1.1}
\begin{tabular}{|l|c|c|c|}
\hline
\textbf{Entity type} & \texttt{HIGH} & \texttt{MEDIUM} & \texttt{LOW} \\
\hline
NAME                 & x &   &   \\
EMAIL                & x & x &   \\
PHONE\_NUMBER        & x & x &   \\
ADDRESS              & x & x &   \\
PATIENT\_ID          & x & x &   \\
NON\_PERSONAL\_ID    & x & x & x \\
BIRTHDATE            & x & x & x \\
AGE                  & x & x & x \\
UNIQUE\_FACT         & x & x & x \\
INDIRECT\_IDENTIFIER & x & x & x \\
MEDICAL\_CONDITION   & x & x & x \\
EVENT\_DATE          & x & x & x \\
LOCATION             & x & x & x \\
DEMOGRAPHIC          & x & x & x \\
EVENT                & x & x & x \\
PROVIDER             & x & x & x \\
TREATMENT            & x & x & x \\
\hline
\end{tabular}
\end{table}
